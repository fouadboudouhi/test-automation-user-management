services:
  mariadb:
    image: yobasystems/alpine-mariadb:10.6.11
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: user
      MYSQL_PASSWORD: root
      MYSQL_DATABASE: toolshop
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -proot --silent || exit 1"]
      interval: 2s
      timeout: 2s
      retries: 60

  laravel-api:
    image: testsmith/practice-software-testing-${SPRINT:-sprint5}-api
    depends_on:
      - mariadb
    environment:
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"
      DB_PORT: "3306"
      DB_HOST: mariadb
      host: localhost
      DISABLE_LOGGING: "${DISABLE_LOGGING:-true}"
    volumes:
      - laravel-app-code:/var/www

  # Multi-arch nginx proxy for the Laravel API (CI-safe)
  # Exposes API_DOC_URL on host: http://localhost:${API_PORT}/api/documentation
  web:
    image: nginx:1.25-alpine
    ports:
      - "${API_PORT:-8091}:80"
    depends_on:
      - laravel-api
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - laravel-app-code:/var/www:ro

  angular-ui:
    image: testsmith/practice-software-testing-${SPRINT:-sprint5}-ui
    ports:
      - "${UI_PORT:-4200}:4200"
    command: bash -c "ng serve --host 0.0.0.0 --port 4200"
    depends_on:
      - web

volumes:
  laravel-app-code: